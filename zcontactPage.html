<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="zstyles.css" />
  </head>
  <body>
    <section class="requestSection" id="requestSection">
      <h2 class="requestTitle">Make Request</h2>
      <form action="" class="text-area-form" id="form">
        <div class="selector">
          <label>Select Request Heading</label>
          <div id="selectField">
            <p id="selectText">Select Request Heading</p>
            <span id="arrowIcon" class="arrow"
              ><div class="faq-item__arrow-container">
                <img
                  src="/images/icon-arrow-down.svg"
                  alt="arrow"
                  class="faq-item__arrow-icon" /></div
            ></span>
          </div>

          <p id="selectReqError"></p>

          <ul id="list" class="hide">
            <li class="options"><p>Request Niches I want Jobs on</p></li>
            <li class="options"><p>Request Robertson Task Solution</p></li>
            <li class="options"><p>Request Runge Task Solution</p></li>
            <li class="options"><p>Request Ruud Task Solution</p></li>
            <li class="options"><p>Request Yidarmys Task Solution</p></li>
          </ul>
        </div>
        <section class="textArea">
          <label for="messageId">Enter Niches you want jobs on below</label>
          <textarea
            maxlength="550"
            placeholder="
job 1 - [Niche]
job 2 - [Niche]
job 3 - [Niche]
job 4 - [Niche]
"
            id="messageId"></textarea>
          <p id="textAreaError" class="error"></p>
        </section>

        <article class="messageReceived" id="messageReceived">
          <h1>Thank You!</h1>
          <p>Your Request has Been Received.</p>
          <p id="infoOnDeliveryTime"></p>
        </article>

        <button id="submitRequestBtn">Submit</button>
      </form>
    </section>

    <script>
      const messageId = document.getElementById("messageId");
      const form = document.getElementById("form");
      const textAreaError = document.getElementById("textAreaError");
      const messageReceived = document.getElementById("messageReceived");
      const selectReqError = document.getElementById("selectReqError");
      const selectField = document.getElementById("selectField");
      const selectText = document.getElementById("selectText");
      const list = document.getElementById("list");
      const arrowIcon = document.getElementById("arrowIcon");
      const infoOnDeliveryTimeEl =
        document.getElementById("infoOnDeliveryTime");
      const options = document.getElementsByClassName("options");
      const websiteUrl = "https://workforreputation.com";

      let deliveryTime;

      // logoutBtn.addEventListener("click", logout);

      const setError = (messageId, message) => {
        textAreaError.innerText = message;
        messageId.classList.add("error");
      };

      const setSuccess = (messageId) => {
        textAreaError.innerText = "";
        messageId.classList.add("success");
      };

      const MessageReceivedVisibilty = (element) => {
        element.style.visibility = "visible";
        infoOnDeliveryTimeEl.innerHTML = `${deliveryTime}`;
      };

      function validateRequestHeading() {
        const selectTextValue = selectText.textContent;
        console.log(selectTextValue);
        if (selectTextValue == "Select Request Heading") {
          selectReqError.innerHTML = "You Must Select a Request Heading";
          selectField.style.borderColor = "#ff3860";
          return false;
        } else {
          selectField.classList.add("success");
          selectReqError.innerHTML = "";
          return true;
        }
      }
      function validateTextArea() {
        const messageValue = messageId.value.trim();
        if (messageValue === "") {
          setError(messageId, "Request cannot be empty");
          return false;
        } else if (messageValue.length < 4) {
          setError(messageId, "Request must be at least 4 characters.");
          return false;
        } else {
          setSuccess(messageId);
          return true;
        }
      }

      function textAreaValidity() {
        if (validateTextArea() && validateRequestHeading()) {
          sendRequest();
        } else return false;
      }
      function headerValidity() {
        if (validateRequestHeading()) {
          sendRequest();
        } else return false;
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (selectField.textContent.trim() == "Request Niches I want Jobs on") {
          textAreaValidity();
        } else if (
          selectField.textContent.trim() != "Request Niches I want Jobs on"
        ) {
          headerValidity();
        } else return false;
      });

      function sendRequest() {
        async function sendUserRequest() {
          let message;

          if (
            selectField.textContent.trim() == "Request Niches I want Jobs on"
          ) {
            message = messageId.value;
            deliveryTime = "You will get your first invite in 6 hours.";
          } else {
            message = `I hereby ${selectField.textContent}`;
            deliveryTime = "The solution will be mailed to you in 6 hours.";
          }

          const requestHeader = selectField.textContent;

          const res = await fetch(`${websiteUrl}/api/requests-made`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },

            body: JSON.stringify({
              message,
              requestHeader,
            }),
          });

          const data = await res.json();
          console.log(data);

          if (data.messageError) {
            return setError(
              messageId,
              "Request must be at least 3 characters long"
            );
          }

          if (data.emailSent) {
            MessageReceivedVisibilty(messageReceived);
          }
        }

        sendUserRequest().catch((error) => {
          console.log("error");
          console.log(error);
        });
      }

      // Selection Menu Block

      selectField.onclick = function () {
        list.classList.toggle("hide");
        arrowIcon.classList.toggle("rotate");
      };

      const textArea = document.querySelector(".textArea");

      for (option of options) {
        option.onclick = function () {
          selectText.innerHTML = this.textContent;
          list.classList.toggle("hide");
          arrowIcon.classList.toggle("rotate");

          if (selectText.textContent != "Select Request Heading") {
            selectReqError.innerHTML = "";
            selectField.style.borderColor = "#14a800";
          }

          if (selectText.textContent == "Request Niches I want Jobs on") {
            textArea.style.display = "block";
          } else return (textArea.style.display = "none");
        };
      }

      // Menu Bar Scrolling and Display Fix
      const rules = document.querySelector(".rules");
      const makeRequest = document.querySelector(".makeRequest");
      const faq = document.querySelector(".faq");

      function closeMenuBar() {
        document.getElementById("nav__checkbox").checked = false;
      }

      rules.addEventListener("click", () => {
        closeMenuBar();
        smoothScroll(".safety-rules-container", 1000, 140);
      });

      makeRequest.addEventListener("click", () => {
        closeMenuBar();
        smoothScroll(".requestSection", 1000, 60);
      });
      faq.addEventListener("click", () => {
        closeMenuBar();
        smoothScroll(".faq__text-container", 1000, 100);
      });

      function smoothScroll(target, duration, heightAdjuster) {
        var target = document.querySelector(target);
        var targetPosition = target.getBoundingClientRect().top;
        var startPosition = window.pageYOffset;
        var distance = targetPosition - heightAdjuster; // - startPosition;
        var startTime = null;

        function animation(currentTime) {
          if (startTime === null) startTime = currentTime;
          var timeElapsed = currentTime - startTime;
          var run = ease(timeElapsed, startPosition, distance, duration);
          window.scrollTo(0, run);
          if (timeElapsed < duration) requestAnimationFrame(animation);
        }

        // http://www.gizma.com/easing/
        function ease(t, b, c, d) {
          t /= d / 2;
          if (t < 1) return (c / 2) * t * t + b;
          t--;
          return (-c / 2) * (t * (t - 2) - 1) + b;
        }

        requestAnimationFrame(animation);
      }
    </script>
  </body>
</html>
